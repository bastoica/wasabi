package edu.uchicago.cs.systems.wasabi.verify;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public aspect %%ASPECT_NAME%% {
    private static final Logger logger = LoggerFactory.getLogger("AspectVerify");
    private static final int NUM_FAILURES_TO_INJECT=1;
    private static int requestAttempts=0;
    private static int failuresInjected=0;

    private static String executedRequestMethods = "";
    private static String testMethodName = "";

    pointcut testMethod():
        (execution(* *(..)) && 
          ( @annotation(org.junit.Test) 
            || @annotation(org.junit.jupiter.api.Test) 
          //  || @annotation(org.junit.jupiter.params.ParameterizedTest)
          ));


    before() : testMethod() {
        log("Test-Before", thisJoinPoint.toString());
        requestAttempts=0; 
        failuresInjected=0;
        testMethodName=thisJoinPoint.toString();
    }

    after() returning: testMethod() {
        if (requestAttempts > 0) {
          log("Test-After", "SUCCESS", "%%REQUEST_METHOD%%", thisJoinPoint.toString(), String.valueOf(failuresInjected), String.valueOf(requestAttempts), executedRequestMethods);
        }
    }

    after() throwing (Throwable t): testMethod() {
        if (requestAttempts > 0) {
          log("Test-After", "FAILURE", "%%REQUEST_METHOD%%", thisJoinPoint.toString(), String.valueOf(failuresInjected), String.valueOf(requestAttempts), executedRequestMethods, t.toString());
        }
    }

    pointcut requestMethod():
        (execution(%%REQUEST_METHOD%%) && if(%%REQ_METHOD_ONLY%%)) ||
        (cflow(execution(%%ENCLOSING_METHOD%%)) && execution(%%REQUEST_METHOD%%) && if(!%%REQ_METHOD_ONLY%%));
    
    after() throws %%EXCEPTION%% : requestMethod() {
        if(testMethodName.isEmpty()) {
          log("Request executed without test tracking. Ignoring.", thisJoinPoint.toString());
          return;
        }

        if(thisJoinPoint.toString().toLowerCase().contains("mock") || thisJoinPoint.toString().toLowerCase().contains("test")) {
          log("Request executed on mock/test object. Ignoring.", thisJoinPoint.toString());
          return;
        }

        if (!executedRequestMethods.contains(thisJoinPoint.toString())) {
          executedRequestMethods += thisJoinPoint.toString()+ ";";
        }

        requestAttempts++;
        if (requestAttempts <= NUM_FAILURES_TO_INJECT) {
            failuresInjected++;
            log("Request-Inject", thisJoinPoint.toString(), String.valueOf(failuresInjected), String.valueOf(requestAttempts));
            %%THROW_STMT%%;
        } else {
            log("Request-Proceed", thisJoinPoint.toString(), String.valueOf(failuresInjected), String.valueOf(requestAttempts));
        }
    }

    private void log(String... params) {
      String message = "[wasabi] " + String.join("::", params)+"::";
      // Logger not working for kafka client tests, use println instead
      // logger.error(message);
      System.out.println(message);
    }
}
